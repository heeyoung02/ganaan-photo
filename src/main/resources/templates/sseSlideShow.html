<!DOCTYPE html>
<html xmlns:th="http://thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŠ¬ë¼ì´ë“œì‡¼</title>
    <style>
        /* ì „ì²´ í™”ë©´ì„ ì‚¬ìš©í•˜ë„ë¡ ì„¤ì • */
        html, body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden; /* ìŠ¤í¬ë¡¤ë°”ë¥¼ ìˆ¨ê¸°ê¸° ìœ„í•´ */
        }

        .slide-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            background-color: black; /* ë°°ê²½ ìƒ‰ì„ ê²€ì€ìƒ‰ìœ¼ë¡œ */
        }
        .slide {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: contain;  /* ì´ë¯¸ì§€ê°€ í™”ë©´ì— ë§ê²Œ ë¹„ìœ¨ì„ ìœ ì§€í•˜ë©´ì„œ ë§ì¶°ì§ */
            opacity: 0;  /* ì²˜ìŒì—ëŠ” ì´ë¯¸ì§€ê°€ ë³´ì´ì§€ ì•Šë„ë¡ ì„¤ì • */
            transition: opacity 1s ease-in-out;  /* ë¶€ë“œëŸ½ê²Œ í˜ì´ë“œ ì¸/ì•„ì›ƒ ì• ë‹ˆë©”ì´ì…˜ */
        }
        .slide.visible {
            opacity: 1;  /* visible í´ë˜ìŠ¤ê°€ ì¶”ê°€ë˜ë©´ ì´ë¯¸ì§€ë¥¼ ë³´ì´ë„ë¡ */
        }

    </style>
</head>
<body>

<div class="slide-container">
    <img th:each="fileName : ${fileList}" th:src="@{'/rest/photo/' + ${fileName}}" class="slide" alt="Slide Image">
    <div class="no-slide-message" id="noSlideMsg" style="display: none; color: white; font-size: 2rem; text-align: center;">
        â— ìŠ¬ë¼ì´ë“œì— í‘œì‹œí•  ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.
    </div>
</div>


<script>
    const slideContainer = document.querySelector('.slide-container');
    let slides = [];
    let currentIndex = 0;

    // =========================
    // ğŸ’¡ ìŠ¬ë¼ì´ë“œ ê´€ë ¨ í•¨ìˆ˜
    // =========================
    function updateSlides() {
        slides = document.querySelectorAll('.slide');
    }

    function showSlide(index) {
        updateSlides(); // í•­ìƒ ìµœì‹  ìƒíƒœ ë°˜ì˜
        const noSlideMsg = document.getElementById('noSlideMsg'); // ë¹ˆ ìŠ¬ë¼ì´ë“œ ë©”ì„¸ì§€ div
        if (slides.length === 0) {
            noSlideMsg.style.display = 'block';
            return;
        } else {
            noSlideMsg.style.display = 'none';
        }
        slides.forEach(slide => slide.classList.remove('visible'));
        currentIndex = (index + slides.length) % slides.length; // index ë²”ìœ„ ë³´ì •
        setTimeout(() => {
            slides[currentIndex].classList.add('visible');
        }, 100);
    }

    function nextSlide() {
        showSlide(++currentIndex);
    }

    function prevSlide() {
        showSlide(--currentIndex);
    }

    function startSlideInterval() {
        setInterval(nextSlide, 3000);
    }

    // =========================
    // ğŸ’¡ SSEë¡œ ì´ë¯¸ì§€ ì‹¤ì‹œê°„ ìˆ˜ì‹ 
    // =========================
    function initSSE() {
        const eventSource = new EventSource('/sse/subscribe');

        // ì—…ë¡œë“œ ì´ë²¤íŠ¸ ê°ì§€
        eventSource.addEventListener('imageUpdate', (event) => {
            const imageUrl = event.data;
            const newImg = document.createElement('img');
            newImg.src = imageUrl;
            newImg.className = 'slide';
            slideContainer.appendChild(newImg);
            updateSlides();
        });

        // ì‚­ì œ ì´ë²¤íŠ¸ ê°ì§€
        eventSource.addEventListener('imageDelete', (event) => {
            const deletedUrl = event.data;
            const images = document.querySelectorAll('.slide');
            let indexToRemove = -1; // ì¸ë±ìŠ¤ ê°±ì‹  ìœ„í•œ ë³€ìˆ˜

            images.forEach((img, index) => {
                if (img.src.includes(decodeURIComponent(deletedUrl))) {
                    indexToRemove = index;
                    img.remove();
                }
            });
            // ìŠ¬ë¼ì´ë“œ ë¦¬ìŠ¤íŠ¸ ë‹¤ì‹œ ë¡œë“œ
            updateSlides();
            // í˜„ì¬ ì¸ë±ìŠ¤ ì¡°ì •
            if (indexToRemove !== -1) {
                if (indexToRemove <= currentIndex && currentIndex > 0) {
                    currentIndex--; // í˜„ì¬ ë³´ì—¬ì§€ëŠ” ì´ë¯¸ì§€ê°€ ì‚­ì œë˜ì—ˆê±°ë‚˜ ì• ìˆœì„œì¼ ê²½ìš° ë³´ì •
                }
            }
            // í˜„ì¬ ìŠ¬ë¼ì´ë“œ ë‹¤ì‹œ ë³´ì—¬ì£¼ê¸°
            showSlide(currentIndex);
        });

        // ì—°ê²° ìœ ì§€ë¥¼ ìœ„í•œ ping ì „ì†¡
        eventSource.addEventListener("ping", (event) => {
            // const now = new Date();
            // console.log("ğŸ’“ ping", now.toISOString());
        });

        // ë¸Œë¼ìš°ì €ì—ì„œ ì—°ê²° ëŠê¸¸ ê²½ìš° ê°ì§€
        eventSource.onerror = (e) => {
            const now = new Date();
            console.error("âŒ SSE ì—°ê²° ëŠê¹€!!  " + now.toISOString() + "ì¬ì—°ê²°ì¤‘..", e);
            eventSource.close();
            setTimeout(initSSE, 5000); // 5ì´ˆ í›„ ì¬ì—°ê²° ì‹œë„
        };
    }

    // =========================
    // ğŸ’¡ í™”ë©´ ì‚¬ì´ì¦ˆ ë§ì¶¤
    // =========================
    function resizeToFullScreen() {
        slideContainer.style.width = `${window.innerWidth}px`;
        slideContainer.style.height = `${window.innerHeight}px`;
    }

    window.addEventListener('resize', resizeToFullScreen);

    // =========================
    // ğŸ’¡ ì „ì²´í™”ë©´ í† ê¸€
    // =========================
    function toggleFullScreen() {
        const doc = document;
        const el = doc.documentElement;
        if (!doc.fullscreenElement && !doc.webkitFullscreenElement &&
            !doc.mozFullScreenElement && !doc.msFullscreenElement) {
            (el.requestFullscreen || el.webkitRequestFullscreen || el.mozRequestFullScreen || el.msRequestFullscreen).call(el);
        } else {
            (doc.exitFullscreen || doc.webkitExitFullscreen || doc.mozCancelFullScreen || doc.msExitFullscreen).call(doc);
        }
    }

    // =========================
    // ğŸ”° ì´ˆê¸°í™”
    // =========================
    document.addEventListener('DOMContentLoaded', () => {
        updateSlides();
        resizeToFullScreen();
        showSlide(currentIndex);
        startSlideInterval();
        initSSE();
    });

</script>

</body>
</html>

<!DOCTYPE html>
<html xmlns:th="http://thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" th:href="@{/css/style.css}">


  <title>파일 업로드</title>

</head>
<body class="container mt-5">
<h2>파일 업로드</h2>

<div class="alert alert-info" th:if="${message}" th:text="${message}"></div>

<form th:action="@{/save}" method="post" enctype="multipart/form-data">
  <div class="mb-3">
    <label for="fileInput" class="form-label">파일 선택 (최대 10개, 5MB 이하)</label>
    <input type="file" class="form-control" id="fileInput" name="files" multiple required>
  </div>
  <button type="submit" class="btn btn-primary">업로드</button>

  <!-- ✅ 이미지 미리보기 영역 -->
  <div id="preview" class="d-flex flex-wrap"></div>

</form>
<a href="/view">
  <button>view로 가기</button>
</a>
<script>
  document.getElementById("fileInput").addEventListener("change", function(event) {
    let preview = document.getElementById("preview");
    preview.innerHTML = ""; // 기존 미리보기 초기화
    let files = Array.from(event.target.files); // 선택한 파일 목록을 배열로 변환

    if (files.length > 10) {
      alert("최대 10개의 파일만 선택할 수 있습니다.");
      event.target.value = ""; // 선택 초기화
      return;
    }

    let updatedFiles = [...files]; // 실제 업로드할 파일 배열 (삭제 반영)

    files.forEach((file, index) => {
      if (!file.type.startsWith("image/")) return; // 이미지 파일만 미리보기

      let reader = new FileReader();
      reader.onload = function(e) {
        // 개별 이미지 컨테이너 생성
        let div = document.createElement("div");
        div.classList.add("position-relative", "m-2");
        div.style.display = "inline-block";

        // 이미지 태그 생성
        let img = document.createElement("img");
        img.src = e.target.result;
        img.classList.add("img-thumbnail");
        img.style.width = "150px";
        img.style.height = "150px";

        // 삭제 버튼 생성 (❌ 아이콘 추가)
        let btn = document.createElement("button");
        btn.innerHTML = "❌";
        btn.classList.add("position-absolute");
        btn.style.top = "5px";
        btn.style.right = "5px";
        btn.style.border = "none";
        btn.style.background = "rgba(0, 0, 0, 0.7)"; // 검은색 반투명 배경
        btn.style.color = "white";
        btn.style.padding = "5px";
        btn.style.borderRadius = "50%";
        btn.style.cursor = "pointer";

        // 버튼 클릭 시 이미지 삭제 및 파일 목록에서 제거
        btn.onclick = function() {
          div.remove(); // 미리보기 삭제
          updatedFiles.splice(index, 1); // 파일 목록에서 삭제
          updateFileList(updatedFiles); // input 값 업데이트
        };

        // 요소 조립
        div.appendChild(img);
        div.appendChild(btn);
        preview.appendChild(div);
      };
      reader.readAsDataURL(file);
    });

    // 파일 목록 업데이트 함수
    function updateFileList(files) {
      let dataTransfer = new DataTransfer();
      files.forEach(file => dataTransfer.items.add(file));
      document.getElementById("fileInput").files = dataTransfer.files; // input 값 갱신
    }

    updateFileList(updatedFiles); // 초기 파일 목록 저장
  });
</script>
</body>
</html>

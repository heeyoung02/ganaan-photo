<!DOCTYPE html>
<html xmlns:th="http://thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <link rel="stylesheet" th:href="@{/css/style.css}">
  <title>íŒŒì¼ ì—…ë¡œë“œ</title>
</head>
<body>
<h2>íŒŒì¼ ì—…ë¡œë“œ</h2>

<div class="alert alert-info" th:if="${message}" th:text="${message}"></div>

<form id="uploadForm" enctype="multipart/form-data">
  <div class="mb-3">
    <label for="fileInput" class="form-label">
      íŒŒì¼ ì„ íƒ (ìµœëŒ€ <span th:text="${maxFileCount}"></span>ê°œ,
      <span th:text="${maxFileSize}"></span>MB ì´í•˜)
    </label>
    <input type="file" class="form-control" id="fileInput" name="files" accept="image/*" multiple required style="color: transparent;">
    <!-- íŒŒì¼ê°¯ìˆ˜ ì—¬ê¸°ì— í‘œê¸° -->
    <small id="fileCount" class="text-muted mt-1 d-block"></small>
  </div>
  <button type="submit" class="btn btn-primary">ì—…ë¡œë“œ</button>
  <!-- âœ… ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ -->
    <div id="preview" class="d-flex flex-wrap justify-content-center"></div>
</form>
<!-- ì—¬ê¸°ì— fetch ê²°ê³¼ ë©”ì‹œì§€ë¥¼ í‘œì‹œ -->
<div id="uploadResult" class="mt-3"></div>
<!--<a href="/view" class="btn btn-secondary mt-3">Viewë¡œ ê°€ê¸°</a>-->
<a href="/" class="btn btn-secondary mt-3">ë©”ì¸í˜ì´ì§€</a>

<!-- ì—…ë¡œë“œ ì¤‘ì¼ ë•Œ ë®ì„ ë ˆì´ì–´ -->
<div id="uploadOverlay">
  <div class="message">
    ì—…ë¡œë“œ ì¤‘ì…ë‹ˆë‹¤
    <div class="spinner"></div>
  </div>
</div>


<script th:inline="javascript">

  const updatedFiles = []; // ì—…ë¡œë“œí•  íŒŒì¼ ë¦¬ìŠ¤íŠ¸
  const uploadForm = document.getElementById("uploadForm");
  const fileInput = document.getElementById("fileInput");
  const preview = document.getElementById("preview");
  const overlay = document.getElementById("uploadOverlay");
  const uploadResult = document.getElementById("uploadResult");
  const fileCount = document.getElementById("fileCount");
  const MAX_FILES = [[${maxFileCount}]];
  const MAX_FILE_SIZE = [[${maxFileSize}]] * 1024 * 1024; // 5MB = 5 * 1024 * 1024

  // ğŸ”„ íŒŒì¼ ëª©ë¡ ë° input ìƒíƒœ ë™ê¸°í™”
  function updateFileList() {
    const dataTransfer = new DataTransfer();
    updatedFiles.forEach(file => dataTransfer.items.add(file));
    fileInput.files = dataTransfer.files;
    fileCount.textContent = `ì„ íƒëœ íŒŒì¼: ${updatedFiles.length}ê°œ`;
  }

  // ğŸ–¼ ë¯¸ë¦¬ë³´ê¸° ì¹´ë“œ ìƒì„±
  function createImagePreview(file, dataUrl) {
    const div = document.createElement("div");
    div.className = "position-relative m-2";
    div.style.display = "inline-block";

    const img = document.createElement("img");
    img.src = dataUrl;
    img.className = "img-thumbnail";
    img.style.width = "150px";
    img.style.height = "150px";

    const btn = document.createElement("button");
    btn.innerHTML = '<i class="bi bi-x-lg"></i>';
    btn.className = "position-absolute";
    Object.assign(btn.style, {
      top: "5px", right: "5px", border: "none", background: "rgba(0,0,0,0.5)",
      color: "white", padding: "4px", borderRadius: "50%", cursor: "pointer",
      width: "28px", height: "28px", display: "flex", justifyContent: "center", alignItems: "center"
    });

    btn.onclick = () => {
      div.remove();
      const idx = updatedFiles.findIndex(f => f.name === file.name && f.size === file.size);
      if (idx > -1) updatedFiles.splice(idx, 1);
      updateFileList();
    };

    div.appendChild(img);
    div.appendChild(btn);
    preview.appendChild(div);
  }

  // ğŸ“‚ íŒŒì¼ ì„ íƒ ì´ë²¤íŠ¸
  fileInput.addEventListener("change", (event) => {
    const newFiles = Array.from(event.target.files);

    if (updatedFiles.length + newFiles.length > MAX_FILES) {
      alert(`ìµœëŒ€ ${MAX_FILES}ê°œì˜ íŒŒì¼ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
      event.target.value = "";
      return;
    }

    newFiles.forEach(file => {
      if (!file.type.startsWith("image/")) return;
      if (file.size > MAX_FILE_SIZE) {
        alert(`"${file.name}" íŒŒì¼ì€ ìµœëŒ€ ${Math.floor(MAX_FILE_SIZE / 1024 / 1024)}MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
        return;
      }
      if (updatedFiles.some(f => f.name === file.name && f.size === file.size)) return;

      updatedFiles.push(file);

      const reader = new FileReader();
      reader.onload = (e) => createImagePreview(file, e.target.result);
      reader.readAsDataURL(file);
    });
    updateFileList();
    uploadResult.innerHTML = ""; // íŒŒì¼ ì—…ë¡œë“œ ì„±ê³µ ë©”ì„¸ì§€ ìˆ¨ê¸°ê¸°
  });


  // ğŸš€ í¼ ì œì¶œ ì´ë²¤íŠ¸
  uploadForm.addEventListener("submit", (e) => {
    e.preventDefault();
    overlay.style.display = "flex";

    const formData = new FormData();
    updatedFiles.forEach(file => formData.append("files", file));

    fetch("/save", {
      method: "POST",
      body: formData
    })
            .then(res => res.text())
            .then(message => {
              overlay.style.display = "none";
              uploadResult.innerHTML = `<div class="alert alert-success">${message}</div>`;
              updatedFiles.length = 0;
              preview.innerHTML = "";
              fileInput.value = "";
              updateFileList();
            })
            .catch(err => {
              overlay.style.display = "none";
              uploadResult.innerHTML = `<div class="alert alert-danger">ì—…ë¡œë“œ ì‹¤íŒ¨: ${err.message}</div>`;
              uploadResult.focus();
            });
  });

</script>
</body>
</html>

